#!/usr/bin/env bash
#
# Run all dotfiles installers.

set -e

# åˆ‡æ›åˆ° .dotfiles æ ¹ç›®éŒ„
cd "$(dirname $0)"/..
DOTFILES_ROOT=$(pwd) # å–å¾—ç•¶å‰çµ•å°è·¯å¾‘ï¼Œæ¯”å¯«æ­» $HOME/.dotfiles æ›´éˆæ´»

echo "ğŸš€ Starting Dotfiles Installation from: $DOTFILES_ROOT"

# -----------------------------------------------------------
# 1. å®‰è£æ ¸å¿ƒè»Ÿé«” (Core Software)
# -----------------------------------------------------------
echo "â€º brew bundle (Core Software) | å®‰è£æ ¸å¿ƒè»Ÿé«”"
# åŠ å…¥ --verbose ä»¥ä¾¿åœ¨èˆŠæ©Ÿå™¨ä¸Šè§€å¯Ÿé€²åº¦
brew bundle --verbose --file="Brewfile" || true

# -----------------------------------------------------------
# 2. å®‰è£å­—é«” (Fonts) - ç¨ç«‹è™•ç†
# -----------------------------------------------------------
if [ -f "Brewfile.fonts" ]; then
    echo "â€º brew bundle (Fonts) | å®‰è£å­—é«”"
    brew bundle --verbose --file="Brewfile.fonts" || true
else
    echo "â€º Warning: Brewfile.fonts not found, skipping fonts. | æ‰¾ä¸åˆ°å­—é«”æ¸…å–®ï¼Œè·³é"
fi

# -----------------------------------------------------------
# 3. å…¶ä»–ç‰¹å®šå®‰è£èˆ‡è¨­å®š
# -----------------------------------------------------------

# Yabai Window Manager (Only for Apple Silicon)
if [[ $(uname -m) == 'arm64' ]]; then
    echo "â€º Apple Silicon detected. Configuring Yabai..."
    if brew list yabai &>/dev/null; then
        yabai --start-service || true
        echo "  - Yabai service started."
    else
        echo "  - Yabai not found, skipping service start."
    fi
else
    echo "â€º Intel Mac detected. Skipping Yabai service."
fi

# -----------------------------------------------------------
# 4. Lazygit è¨­å®šæª”é€£çµ (è·¨å¹³å°ç›¸å®¹)
# -----------------------------------------------------------
echo "â€º Linking Lazygit config..."

# A. æ¨™æº–è·¯å¾‘ (~/.config/lazygit)
mkdir -p "$HOME/.config/lazygit"
# å‚™ä»½èˆŠæª”
if [ -f "$HOME/.config/lazygit/config.yml" ] && [ ! -L "$HOME/.config/lazygit/config.yml" ]; then
    mv "$HOME/.config/lazygit/config.yml" "$HOME/.config/lazygit/config.yml.bak"
fi
ln -sf "$DOTFILES_ROOT/lazygit/config.yml" "$HOME/.config/lazygit/config.yml"

# B. macOS ç‰¹æ®Šè·¯å¾‘ fix (Application Support)
if [ "$(uname)" = "Darwin" ]; then
    echo "  - Fixing Lazygit path for macOS (Application Support)..."
    MAC_TARGET_DIR="$HOME/Library/Application Support/lazygit"
    mkdir -p "$MAC_TARGET_DIR"
    
    # æ¸…ç†èˆŠçš„ Application Support è¨­å®šï¼Œç¢ºä¿å®ƒæŒ‡å‘æˆ‘å€‘çš„æ–°é€£çµ
    # æ³¨æ„ï¼šé€™è£¡ç›´æ¥å¼·åˆ¶è¦†è“‹ï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“åœ¨ä¸Šé¢ .config å‚™ä»½éäº†ï¼Œä¸”å…©è€…æ‡‰åŒæ­¥
    ln -sf "$DOTFILES_ROOT/lazygit/config.yml" "$MAC_TARGET_DIR/config.yml"
fi

echo "ğŸ”— Lazygit config linked!"

# -----------------------------------------------------------
# 5. åŸ·è¡Œå…¶ä»–å­å®‰è£è…³æœ¬ (Sub-installers)
# -----------------------------------------------------------
# åŒæ„ Xcode æˆæ¬Š
echo "â€º Accepting Xcode license..."
if command -v xcodebuild >/dev/null 2>&1; then
    sudo xcodebuild -license accept || true
fi

echo "â€º Running sub-installers... | åŸ·è¡Œå­å®‰è£è…³æœ¬..."
# æœå°‹æ‰€æœ‰ install.shï¼Œæ’é™¤ .git ç›®éŒ„ï¼Œä¸¦è‡ªå‹•è³¦äºˆåŸ·è¡Œæ¬Šé™
find . -name "install.sh" -not -path '*/.git/*' | while read installer; do
    echo "  - Running ${installer}..."
    chmod +x "${installer}" # è‡ªå‹•ä¿®å¾©æ¬Šé™å•é¡Œ
    bash -c "${installer}"
done

echo "â€º Done! | å®‰è£å®Œæˆï¼"

# -----------------------------------------------------------
# Post-Installation Checks (æ‰‹å‹•å®‰è£æé†’)
# -----------------------------------------------------------

echo ""
echo "=================================================================="
echo "âœ‹ MANUAL ACTION REQUIRED (éœ€è¦æ‰‹å‹•åŸ·è¡Œçš„é …ç›®)"
echo "=================================================================="

# 1. æª¢æŸ¥ Squash 2
if [ -d "/Applications/Squash.app" ]; then
    echo "âœ… [å·²å®‰è£] Squash 2"
else
    echo "âŒ [æœªå®‰è£] Squash 2 (Legacy Version)"
    echo "   ğŸ‘‰ åŸå› : èˆŠç‰ˆå·²å¾å•†åº—ç´¢å¼•ç§»é™¤ï¼Œmas æŒ‡ä»¤ç„¡æ³•ä¸‹è¼‰ã€‚"
    echo "   ğŸ‘‰ å‹•ä½œ: è«‹é–‹å•Ÿ App Store -> å¸³è™Ÿ -> å·²è³¼é …ç›® -> æ‰‹å‹•ä¸‹è¼‰ã€‚"
fi

# 2. æª¢æŸ¥ Git User Email
if git config --global user.email > /dev/null 2>&1; then
    echo "âœ… [å·²è¨­å®š] Git User Email"
else
    echo "âŒ [æœªè¨­å®š] Git User Email"
    echo "   ğŸ‘‰ å‹•ä½œ: git config --global user.email 'your@email.com'"
fi

# 3. æª¢æŸ¥å­—é«”
if [ -d "$HOME/Library/Fonts/MapleMono-NF-CN-Regular.ttf" ] || \
   [ -f "$HOME/Library/Fonts/MapleMono-NF-CN-Regular.ttf" ]; then
    echo "âœ… [å·²å®‰è£] Maple Mono NF CN"
else
    echo "â„¹ï¸  [æª¢æŸ¥] å¦‚æœå­—é«”é¡¯ç¤ºç•°å¸¸ï¼Œè«‹ç¢ºèªå­—é«”æ˜¯å¦å·²æ­£ç¢ºè¼‰å…¥ã€‚"
fi

echo "=================================================================="
echo ""
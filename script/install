#!/usr/bin/env bash
#
# Run all dotfiles installers.

set -e

cd "$(dirname $0)"/..

# -----------------------------------------------------------
# 1. å®‰è£æ ¸å¿ƒè»Ÿé«” (Core Software)
# -----------------------------------------------------------
echo "â€º brew bundle (Core Software) | å®‰è£æ ¸å¿ƒè»Ÿé«”"
# åŠ å…¥ --verbose ä»¥ä¾¿åœ¨èˆŠæ©Ÿå™¨ä¸Šè§€å¯Ÿé€²åº¦
brew bundle --verbose --file="Brewfile"

# -----------------------------------------------------------
# 2. å®‰è£å­—é«” (Fonts) - ç¨ç«‹è™•ç†
# -----------------------------------------------------------
# æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ï¼Œä¸¦ä½¿ç”¨ || true å…è¨±å¤±æ•—ç¹¼çºŒ (å­—é«”ä¸‹è¼‰å¸¸é€¾æ™‚)
if [ -f "Brewfile.fonts" ]; then
    echo "â€º brew bundle (Fonts) | å®‰è£å­—é«”"
    brew bundle --verbose --file="Brewfile.fonts" || true
else
    echo "â€º Warning: Brewfile.fonts not found, skipping fonts. | æ‰¾ä¸åˆ°å­—é«”æ¸…å–®ï¼Œè·³é"
fi

# -----------------------------------------------------------
# 3. å…¶ä»–ç‰¹å®šå®‰è£èˆ‡è¨­å®š
# -----------------------------------------------------------

# Yabai Window Manager Configuration (Only for Apple Silicon)
# Yabai è¦–çª—ç®¡ç†è¨­å®š (åƒ…é™ Apple Silicon / M1 / M2)
if [[ $(uname -m) == 'arm64' ]]; then
    echo "â€º Apple Silicon detected. Configuring Yabai... | åµæ¸¬åˆ° Apple Siliconï¼Œè¨­å®š Yabai..."
    # ç¢ºä¿ yabai å·²å®‰è£ (Brewfile å·²ç¶“è™•ç†äº†ï¼Œé€™è£¡ç¢ºä¿æœå‹™å•Ÿå‹•)
    if brew list yabai &>/dev/null; then
        yabai --start-service || true
        echo "  - Yabai service started."
    else
        echo "  - Yabai not found (skipped in Brewfile?), skipping service start."
    fi
else
    echo "â€º Intel Mac detected. Skipping Yabai service. | åµæ¸¬åˆ° Intel Macï¼Œè·³é Yabai è¨­å®š"
fi

# -----------------------------------------------------------
# 4. åŸ·è¡Œå…¶ä»–å­å®‰è£è…³æœ¬
# -----------------------------------------------------------
# ç¢ºä¿ç›®æ¨™ç›®éŒ„å­˜åœ¨
mkdir -p "$HOME/.config/lazygit"

# å‚™ä»½èˆŠçš„ (å¦‚æœå­˜åœ¨ä¸”ä¸æ˜¯é€£çµ)
if [ -f "$HOME/.config/lazygit/config.yml" ] && [ ! -L "$HOME/.config/lazygit/config.yml" ]; then
    mv "$HOME/.config/lazygit/config.yml" "$HOME/.config/lazygit/config.yml.bak"
fi

# å»ºç«‹é€£çµ
ln -sf "$HOME/.dotfiles/lazygit/config.yml" "$HOME/.config/lazygit/config.yml"

echo "ğŸ”— Lazygit config linked!"


# åŒæ„ Xcode æˆæ¬Š (éœ€è¦ sudo å¯†ç¢¼)
echo "â€º Accepting Xcode license... | åŒæ„ Xcode æˆæ¬Š (éœ€è¼¸å…¥å¯†ç¢¼)"
sudo xcodebuild -license accept || true

# å°‹æ‰¾ä¸¦åŸ·è¡Œå…¶ä»–å­ç›®éŒ„ä¸‹çš„ install.sh
echo "â€º Running sub-installers... | åŸ·è¡Œå­å®‰è£è…³æœ¬..."
find . -name install.sh | while read installer ; do sh -c "${installer}" ; done

echo "â€º Done! | å®‰è£å®Œæˆï¼"